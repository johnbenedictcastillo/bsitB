<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="../styles/custom.css">

</head>

<body>
    <div class="container-fluid p-4">
        <h2 class="my-0 me-auto">Products</h2>

        <div class="text-end">
            <button class="btn btn-sm btn-dark" type="button" data-bs-toggle="modal" data-bs-target="#add-modal">Add
                New
            </button>
        </div>
        <table class="table mt-3 ">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Price</th>
                    <th>Category</th>
                    <th>Type</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="tb">
                <tr>
                    <td colspan="7">
                        <p class="text-center">Fetching data...</p>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- add modal -->
    <div class="modal fade" tabindex="-1" id="add-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="#" id="add-form">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="" class="form-label">Images</label>
                            <input type="file" class="form-control" id="images" multiple accept=".jpg,.png,.webp">
                        </div>
                        <div class="mb-3">
                            <label for="" class="form-label">Name</label>
                            <input type="text" class="form-control name">
                        </div>
                        <div class="mb-3">
                            <label for="" class="form-label">Description</label>
                            <textarea class="form-control description"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="" class="form-label">Price</label>
                            <input type="number" class="form-control price">
                        </div>
                        <div class="mb-3">
                            <label for="" class="form-label">Category</label>
                            <select name="" id="category-list" class="form-select"></select>
                        </div>
                        <div class="mb-3">
                            <label for="" class="form-label">Type</label>
                            <select name="" id="type-list" class="form-select"></select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Add product</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"
        integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- JavaScript Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="../scripts/backend.js"></script>
    <script src="../scripts/main.js"></script>

    <script>
        const loadProducts = async () => {
            const { data, error } = await connection
                .from('products')
                .select("*, category(*), product_images:product_images_productId_fkey(src),type(description)")
            if (data) {
                $("#tb").html("");
                for (let product of data) {
                    let row = `
                    <tr>
                        <td>${product.id}</td>
                        <td>${product.name}</td>
                        <td>${product.description}</td>
                        <td>${product.price}</td>
                        <td>${product.category.description}</td>
                        <td>${product.type.description}</td>
                        <td>
                            <a href="edit.html" data-id="${product.id}" class="delete btn btn-success m-1 btn-sm">Edit</a>
                            <a href="#" data-id="${product.id}" class="delete btn btn-danger m-1 btn-sm">Delete</a>
                            
                        </td>
                    </tr>
                        `
                    $("#tb").append(row)

                }
            }
            $(".delete").on("click", async function (e) {
                e.preventDefault();
                const id = $(this).data("id");
                const { data, error } = await connection
                    .from('product_images')
                    .delete()
                    .match({ productId: id })
                console.log({ data, error })
                if (data) {
                    const { data, error } = await connection
                        .from('products')
                        .delete()
                        .match({ id: id })
                }
            })

        }

        const loadData = async () => {
            const { data, error } = await connection
                .from('category')
                .select("*")
            const list = $("#category-list")
            const typeList = $("#type-list")
            list.html("")
            typeList.html("")

            if (data) {
                for (let category of data) {
                    let option = `<option value="${category.id}">${category.description}</option>`
                    list.append(option)
                }
            }

            const types =  await connection
            .from('type')
            .select("*")

            for(let type of types.data){
                let option = `<option value="${type.id}">${type.description}</option>`
                    typeList.append(option)
            }
        }
        $(function () {
            loadProducts();
            loadData();
            const mySubscription = connection
                .from('products')
                .on('*', payload => {
                    console.log("chenges")
                    row.html(`
                        <tr>
                            <td colspan="7"></td>
                        </tr>
                        `)
                    loadProducts();
                })
                .subscribe()
        })
    </script>
</body>

</html>